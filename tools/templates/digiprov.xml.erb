<?xml version="1.0" encoding="UTF-8"?>
<premis xmlns="info:lc/xmlns/premis-v2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" version="2.0">

<% require 'nokogiri'                                            %>
<%# hash of DAITSS event_codes and English translations:         %>
<%  daitss_events = {                                            %>
<%              :CPD => "decrease preservation level",           %>
<%              :CPU => "increase preservation level",           %>
<%              :CV  => "virus check",                           %>
<%              :D   => "disseminate",                           %>
<%              :DEL => "deleted a previously ingested file",    %>
<%              :DLK => "downloaded link",                       %>
<%              :FC  => "fixity Check",                          %>
<%              :I   => "ingest",                                %>
<%              :L   => "localized",                             %>
<%              :M   => "migrated",                              %>
<%              :N   => "normalized",                            %>
<%              :RM  => "refreshed media",                       %>
<%              :UNKNOWN => "unknown event type",                %>
<%              :VC  => "verify checksum",                       %>
<%              :WA  => "withdraw by affiliate",                 %>
<%              :WO  => "withdraw by operator"                   %>
<%                  }                                            %>
<%                                                               %>
<%# hash of roles for linked events                              %>
<%  daitss_roles = {                                             %>
<%              :DLK => "Local copy of linked file",             %>
<%              :L   => "Version of file with local links",      %>
<%              :M   => "Migrated file"                          %>
<%                  }                                            %>
<%# Our namespaces to retrieve information from our dip          %>
<%  xmlns = { "daitss" => "http://www.fcla.edu/dls/md/daitss/" } %>
    <!-- DAITSS events:  
<% event_array = daitss_events.map { |k, v| ["#{k}", v] } %>
<% event_array.sort.each do |a| %>
           <%= "#{a[0]}:" + " #{a[1]}" %>
<% end %>
     -->
     
<%# Print out our representation %>
  <!-- Representation object -->
  <object xsi:type="representation">
    <objectIdentifier>
      <objectIdentifierType>DAITSS</objectIdentifierType>
      <objectIdentifierValue>
        <!-- daitss:OID -->
        <%= "#{@package_id}-rep-#{@rep_num}" %>
      </objectIdentifierValue>
    </objectIdentifier>
  </object>
  
<%# Print out file objects      %>
  <!-- File objects -->
<% @events.each do |event| %>
<%   if event[:events].first.xpath("daitss:OID", xmlns).first.content.strip != @package_id %>
<%     oid = event[:events].first.xpath("daitss:OID", xmlns).first.content    %>
<%     format = event[:object_format] %>
  <object xsi:type="file">
    <objectIdentifier>
      <objectIdentifierType>DAITSS</objectIdentifierType>
      <objectIdentifierValue>
        <!-- daitss:OID -->
        <%= oid %>
      </objectIdentifierValue>
    </objectIdentifier>
    <objectCharacteristics>
      <compositionLevel>0</compositionLevel>
      <format>
        <formatDesignation>
	  <formatName><%= format %></formatName>
	</formatDesignation>
      </format>
    </objectCharacteristics>
  </object>
<%  end %>
<% end %>

<%# Print out events       %>
<% @events.each do |event| %>
<%   event[:events].each do |e|     %>
  <event>
  
    <!-- Converted from DAITSS schema -->
    <eventIdentifier>
      <eventIdentifierType>DAITSS</eventIdentifierType>
      <eventIdentifierValue>
        <!-- daitss:EVENT ID -->
        <%= e.xpath('./daitss:ID', xmlns).first.content %>
      </eventIdentifierValue>
    </eventIdentifier>
 
    <eventType>
      <!-- Nice description of DAITSS:EVENT_TYPE. See codes above. -->
      <%= daitss_events[:"#{e.xpath('./daitss:EVENT_TYPE', xmlns).first.content}"] %>
    </eventType>
 
    <eventDateTime>
      <!-- daitss:DATE_TIME in 8601 -->
      <%= Time.parse(e.xpath('./daitss:DATE_TIME', xmlns).first.content).xmlschema %>
    </eventDateTime>
 
    <eventDetail>
      <!-- daitss:EVENT_PROCEDURE -->
      <%= e.xpath('./daitss:EVENT_PROCEDURE', xmlns).first.content %>
    </eventDetail>
 
    <eventOutcomeInformation>
      <eventOutcome>
        <!-- daitss:OUTCOME -->
        <%= e.xpath("./daitss:OUTCOME", xmlns).first.content %>
      </eventOutcome>
      <eventOutcomeDetail>
        <eventOutcomeDetailNote>
          <!-- daitss:NOTE -->
          <%= e.xpath("./daitss:NOTE", xmlns).first.content %>
        </eventOutcomeDetailNote>  
      </eventOutcomeDetail>
    </eventOutcomeInformation>

  <!-- Related File Object -->
  <linkingObjectIdentifier>
    <linkingObjectIdentifierType>DAITSS</linkingObjectIdentifierType>
    <linkingObjectIdentifierValue>
      <%= e.xpath("./daitss:OID", xmlns).first.content %>
    </linkingObjectIdentifierValue>
  </linkingObjectIdentifier>
  
<% if not e.xpath("./daitss:OID", xmlns).first.content.strip == @package_id %>
  <!-- Related Representation Object -->
  <linkingObjectIdentifier>
    <linkingObjectIdentifierType>DAITSS</linkingObjectIdentifierType>
    <linkingObjectIdentifierValue>
      <%= "#{@package_id}-rep-#{@rep_num}" %>
    </linkingObjectIdentifierValue>
      <linkingObjectRole>associated representation</linkingObjectRole>
  </linkingObjectIdentifier>
<% end %>
  
<% if not e.xpath("./daitss:REL_OID", xmlns).empty? %>
  <linkingObjectIdentifier>
    <linkingObjectIdentifierType>DAITSS</linkingObjectIdentifierType>
    <linkingObjectIdentifierValue>
      <!-- daitss:REL_OID -->
      <%= e.xpath("./daitss:REL_OID", xmlns).first.content %>
    </linkingObjectIdentifierValue>
      <linkingObjectRole>
        <!-- A nice description of the related file's role
             FIXME: check to make sure we address all potential relationships
          -->
        <%= daitss_roles[:"#{e.xpath('./daitss:EVENT_TYPE', xmlns).first.content}"] %>
      </linkingObjectRole>
  </linkingObjectIdentifier>
<%     end %>  
  </event>
<%   end %>
<% end %> 

</premis>
